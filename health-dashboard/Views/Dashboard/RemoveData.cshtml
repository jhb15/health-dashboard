@using System.Globalization;
@using X.PagedList.Mvc.Common;
@using X.PagedList.Mvc.Core;
@using X.PagedList.Mvc;
@using X.PagedList;

@{
    Dictionary<int, string> ActivityTypeStrings = new Dictionary<int, string>();

    foreach (var at in Model.ActivityTypes)
    {
        ActivityTypeStrings.Add(at.Id, at.Name);
    }
}

<div class="row">
    <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="x_panel tile">
            <div class="x_title">
                <h2>Your Activities</h2>
                <br />
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Activity Type</th>
                            <th>Time Period</th>
                            <th>Calories Burnt</th>
                            <th>Average Heart Rate</th>
                            <th>Steps Taken</th>
                            <th>Metres Travelled</th>
                            <th>Elevation Gained (metres)</th>
                            <th>Remove Activity</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var a in Model.Activities)
                        {
                            <tr>
                                <td>@ActivityTypeStrings[a.ActivityType]</td>
                                <td>
                                    @(DateTime.Parse((string)a.StartTimestamp, CultureInfo.InvariantCulture).ToString())<br />
                                    @(DateTime.Parse((string)a.EndTimestamp, CultureInfo.InvariantCulture).ToString())
                                </td>
                                <td>@a.CaloriesBurnt</td>
                                <td>@a.AverageHeartRate</td>
                                <td>@a.StepsTaken</td>
                                <td>@a.MetresTravelled</td>
                                <td>@a.MetresElevationGained</td>
                                <td><div class="activity-delete-message" data-id="@a.Id"></div><a href="#" class="activity-delete-ajax" data-id="@a.Id">Delete</a></td>
                            </tr>
                        }
                    </tbody>
                </table>
                @Html.PagedListPager((IPagedList)Model.Activities, page => Url.Action("RemoveData", new { page }))
            </div>
        </div>
    </div>
</div>

<script>
    window.onload = function () {
        $(document).ready(function () {
            $('.activity-delete-ajax').click(function (event) {
                if (window.confirm("Are you sure you wish to delete that activity record?")) {
                    event.preventDefault();
                    var link = $(this);

                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("RemoveDataAjax", "Dashboard")' + '/' + link.data("id"),
                        success: function (data, textStatus, jqXHR) {
                            $('.activity-delete-message[data-id=' + link.data("id") + ']').html("<p>Activity deleted successfully.</p>");
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            $('.activity-delete-message[data-id=' + link.data("id") + ']').html("<p>Deletion failed</p>");
                            console.log('.activity-delete-message[data-id=' + link.data("id") + ']')
                            setTimeout(function () {
                                $('.activity-delete-message[data-id=' + link.data("id") + ']').html("");
                            }, 3000);
                        }
                    });
                }
            });
        });
    };
</script>
